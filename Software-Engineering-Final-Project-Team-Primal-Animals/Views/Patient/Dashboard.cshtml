@model Software_Engineering_Final_Project_Team_Primal_Animals.ViewModels.PatientDashboardVM

<div class="container mt-5">

    <h1 class="fw-bold text-primary mb-4">Patient Dashboard</h1>

    <!-- ALERT MESSAGE -->
    @if (!string.IsNullOrEmpty(Model.AlertMessage))
    {
        <div class="alert @(Model.IsHighRisk ? "alert-danger" : "alert-success") fw-bold text-center rounded-3 shadow-sm p-3 mb-4">
            @Model.AlertMessage
        </div>
    }

    <!-- HEATMAP CANVAS -->
    <div id="heatmap-container" class="mb-4 p-3 rounded-3 shadow-sm" style="background: #fafafa; border: 3px solid #ddd;">
        <canvas id="heatmapCanvas" width="480" height="480" style="width:100%;"></canvas>

        <div class="d-flex justify-content-between mt-2 fw-bold">
            <span style="color:blue;">Low Pressure</span>
            <span style="color:red;">High Pressure</span>
        </div>
    </div>

    <script>
        // PROFESSIONAL HEATMAP RENDERING
        const matrixString = "@Model.PressureMatrix";
        if (matrixString && matrixString.length > 0) {

            const values = matrixString.split(',')
                                       .map(v => parseInt(v.trim()))
                                       .filter(v => !isNaN(v));

            const canvas = document.getElementById("heatmapCanvas");
            const ctx = canvas.getContext("2d");

            const gridSize = 32;
            const cellSize = canvas.width / gridSize;

            values.forEach((v, i) => {
                const x = (i % gridSize) * cellSize;
                const y = Math.floor(i / gridSize) * cellSize;

                // Smooth gradient (Blue → Green → Yellow → Red)
                const t = v / 255;
                const r = Math.floor(255 * t);
                const g = Math.floor(255 * (1 - Math.abs(t - 0.5) * 2));
                const b = Math.floor(255 * (1 - t));

                ctx.fillStyle = `rgb(${r}, ${g}, ${b})`;
                ctx.fillRect(x, y, cellSize, cellSize);
            });
        }
    </script>

    <!-- ADVANCED ALERT EFFECTS -->
    @if (Model.IsHighRisk)
    {
        <style>
            #heatmap-container {
                animation: blink 0.8s infinite alternate;
                border: 4px solid red !important;
            }

            @@keyframes blink {
                from {
                    border-color: red;
                }

                to {
                    border-color: darkred;
                }
            }
        </style>

        <audio id="alert-sound">
            <source src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" type="audio/ogg">
        </audio>

        <script>
            document.getElementById("alert-sound").play();
        </script>
    }

    <!-- METRICS PANEL -->
    <div class="card shadow-sm border-0 rounded-4 mb-4">
        <div class="card-body">
            <h4 class="fw-bold text-primary">Pressure Metrics</h4>
            <hr />
            <p><strong>Peak Pressure:</strong> @Model.PeakPressure</p>
            <p><strong>Contact Area:</strong> @Model.ContactArea</p>
            <p><strong>Timestamp:</strong> @Model.Timestamp</p>
        </div>
    </div>

    <!-- EMERGENCY BUTTON -->
    <a href="tel:@Model.EmergencyNumber"
       class="btn @(Model.IsHighRisk ? "btn-danger btn-lg" : "btn-secondary") w-100 mb-4">
        @(Model.IsHighRisk ? "⚠ CALL EMERGENCY NOW" : "Call Emergency Contact")
    </a>

    <!-- COMMENTS -->
    <h3 class="fw-bold mt-5 text-primary">Leave a Comment</h3>
    <form asp-controller="Patient" asp-action="PostComment" method="post">
        <input type="hidden" name="Data_ID" value="@Model.DataId" />
        <textarea class="form-control mb-3" name="CommentText" rows="3" placeholder="Write a comment..."></textarea>
        <button class="btn btn-primary">Submit Comment</button>
    </form>

</div>
